;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ GRAINCARD SPEC (Ketos - inspired by Clojure Spec)                           â•‘
;; â•‘ Team: 06 (teamprecision06 - Virgo â™ / VI. The Lovers)                       â•‘
;; â•‘ Copyright Â© 3x39 | Author: kae3g (kj3x39, @risc.love)                        â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
;;
;; Trish mode: OMG this is SO PRECISE! ğŸ’• We're enforcing EXACT formatting rules
;; for every graincard! The Lovers choose: every grain must have the PERFECT
;; structure or it doesn't validate! Precision with love! âœ¨
;;
;; Purpose: Validate graincard structure and enforce formatting rules
;;   - 80 characters wide (78 + 2 for borders)
;; âœ¨ - Exactly 110 lines total (enforced!)
;;   - Blank lines at specific positions
;;   - Centered 6-char grain code at bottom

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ GRAINCARD DIMENSIONS                                                         â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(define GRAIN-WIDTH 80)
(define GRAIN-CONTENT-WIDTH 78)  ;; 80 - 2 for borders â”‚ ... â”‚
(define GRAIN-HEIGHT 110)

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ BOTTOM LINE SPEC (The Critical Rules!)                                      â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
;;
;; Line 110 (last):     BLANK (empty line after closing ```)
;; Line 109 (2nd last): BLANK (spacing after grain code)
;; Line 108 (3rd last): Grain code CENTERED (6 chars: xbdghj)
;; Line 107 (4th last): BLANK (spacing before grain code)
;; Line 106 (5th last): Closing box: â””â”€â”€â”€â”€...â”€â”€â”€â”€â”˜

(define (spec-last-line-blank? lines)
  "Line 110 must be blank"
  (let ((last-line (nth 109 lines)))  ;; 0-indexed
    (or (nil? last-line) 
        (= "" (string-trim last-line)))))

(define (spec-second-to-last-blank? lines)
  "Line 109 must be blank (spacing after grain code)"
  (let ((line (nth 108 lines)))
    (or (nil? line)
        (= "" (string-trim line)))))

(define (spec-grain-code-centered? lines)
  "Line 108 must have exactly 6 characters, centered
   
   Format: â”‚ Grain: xbdghj (N of 1,235,520)                                               â”‚
           ^       ^6 chars
   
   The grain code appears after 'Grain: ' and must be exactly 6 characters."
  
  (let ((line (nth 107 lines)))  ;; 3rd from bottom (0-indexed line 107)
    (if line
        (let ((trimmed (string-trim line)))
          ;; Look for pattern: â”‚ Grain: {6-char} ...
          (and (string-starts-with? trimmed "â”‚ Grain:")
               (let ((code-match (string-match "Grain: (\\w{6})" line)))
                 (if code-match
                     (= 6 (length (nth 1 code-match)))
                     false))))
        false)))

(define (spec-fourth-from-last-blank? lines)
  "Line 107 must be blank (spacing before grain code)"
  (let ((line (nth 106 lines)))
    (or (nil? line)
        (= "" (string-trim line)))))

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ WIDTH VALIDATION                                                             â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(define (spec-line-width-valid? line)
  "Each line must be â‰¤ 80 chars"
  (<= (length line) GRAIN-WIDTH))

(define (spec-all-lines-width-valid? lines)
  "All lines must be â‰¤ 80 chars"
  (every? spec-line-width-valid? lines))

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ HEIGHT VALIDATION                                                            â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(define (spec-height-valid? lines)
  "Must have exactly 110 lines"
  (= GRAIN-HEIGHT (length lines)))

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ BOX STRUCTURE VALIDATION                                                     â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(define (spec-has-top-border? lines)
  "Must have â”Œâ”€â”€â”€ top border"
  (some? (find (lambda (line) (string-starts-with? (string-trim line) "â”Œâ”€")) 
               lines)))

(define (spec-has-bottom-border? lines)
  "Must have â””â”€â”€â”€ bottom border"
  (some? (find (lambda (line) (string-starts-with? (string-trim line) "â””â”€")) 
               lines)))

(define (spec-has-separator? lines)
  "Must have â”œâ”€â”€â”€ separator before footer"
  (some? (find (lambda (line) (string-starts-with? (string-trim line) "â”œâ”€")) 
               lines)))

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ COMPLETE VALIDATION                                                          â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(define (validate-graincard content)
  "Validate a graincard against all specs
   
   Returns: {:valid true/false
             :errors [list of error messages]}"
  
  (let ((lines (string-split content "\n"))
        (errors '()))
    
    ;; Check height
    (unless (spec-height-valid? lines)
      (set! errors (cons (format "Height must be exactly ~a lines (got ~a)" 
                                 GRAIN-HEIGHT 
                                 (length lines))
                        errors)))
    
    ;; Check width
    (unless (spec-all-lines-width-valid? lines)
      (set! errors (cons "Some lines exceed 80 characters" errors)))
    
    ;; Check box structure
    (unless (spec-has-top-border? lines)
      (set! errors (cons "Missing top border (â”Œâ”€â”€â”€)" errors)))
    
    (unless (spec-has-bottom-border? lines)
      (set! errors (cons "Missing bottom border (â””â”€â”€â”€)" errors)))
    
    (unless (spec-has-separator? lines)
      (set! errors (cons "Missing separator (â”œâ”€â”€â”€)" errors)))
    
    ;; Check bottom line specs (THE CRITICAL ONES!)
    (unless (spec-last-line-blank? lines)
      (set! errors (cons "Line 110 (last) must be blank" errors)))
    
    (unless (spec-grain-code-with-next-button? lines)
      (set! errors (cons "Line 109 (2nd to last) must have 6-char code + > next button" errors)))
    
    (unless (spec-third-from-last-blank? lines)
      (set! errors (cons "Line 108 (3rd to last) must be blank (spacing)" errors)))
    
    ;; Return validation result
    {:valid (empty? errors)
     :errors (reverse errors)}))

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ PRETTY PRINTING                                                              â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(define (print-validation-result result)
  "Pretty print validation result"
  (if (:valid result)
      (do
        (println "âœ… VALID GRAINCARD!")
        (println "   All specs pass. Ready for publication.")
        (println "   now == next + 1 ğŸŒ¾"))
      (do
        (println "âŒ INVALID GRAINCARD!")
        (println "   Errors found:")
        (doseq [err (:errors result)]
          (println "   -" err))
        (println "")
        (println "   Fix these issues and re-validate.")
        (println "   ğŸ’• Trish says: The Lovers choose precision!"))))

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ CLI INTERFACE                                                                 â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(define (main args)
  "Validate graincard files against specs
   
   Usage: graincard-spec.ket <file.md>
   
   Checks:
     - Exactly 110 lines
     - Each line â‰¤ 80 chars
     - Has top/bottom borders and separator
     - Line 110: blank
     - Line 109: blank
     - Line 108: 6-char grain code centered
     - Line 107: blank"
  
  (if (< (length args) 1)
      (do
        (println "ğŸƒ Graincard Spec Validator (Ketos)")
        (println "Copyright Â© 3x39 | Author: kae3g")
        (println "Team: 06 (teamprecision06 - The Lovers)")
        (println "")
        (println "âœ¨ Trish says: Let's make sure every grain is PERFECT! ğŸ’•")
        (println "")
        (println "Usage: graincard-spec.ket <file.md>")
        (println "")
        (println "Validates:")
        (println "  âœ“ Exactly 110 lines")
        (println "  âœ“ Each line â‰¤ 80 chars")
        (println "  âœ“ Line 110: blank")
        (println "  âœ“ Line 109: blank")
        (println "  âœ“ Line 108: 6-char grain code")
        (println "  âœ“ Line 107: blank")
        (println "")
        (println "now == next + 1 ğŸŒ¾"))
      
      (let ((filepath (nth 0 args)))
        (println "ğŸ¬ Validating:" filepath)
        (println "")
        (let ((content (slurp filepath)))
          (let ((result (validate-graincard content)))
            (print-validation-result result)
            ;; Exit code: 0 if valid, 1 if invalid
            (if (:valid result) 0 1))))))

;; Run if executed as script
(when (defined? '*args*)
  (main *args*))

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ EXAMPLE USAGE                                                                 â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
;;
;; $ ketos graincard-spec.ket xbdghj-grainbranch-readme-sync-babashka.md
;; 
;; ğŸ¬ Validating: xbdghj-grainbranch-readme-sync-babashka.md
;; 
;; âœ… VALID GRAINCARD!
;;    All specs pass. Ready for publication.
;;    now == next + 1 ğŸŒ¾

;; â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
;; â•‘ Grainbook Issue 1: Ember Harvest ğŸƒ (System Magazine)                       â•‘
;; â•‘ Module: graincard-spec                                                       â•‘
;; â•‘ now == next + 1 ğŸŒ¾                                                           â•‘
;; â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

